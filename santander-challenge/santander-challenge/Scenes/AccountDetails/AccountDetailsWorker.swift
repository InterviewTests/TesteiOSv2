//
//  AccountDetailsWorker.swift
//  santander-challenge
//
//  Created by Kevin Oliveira on 01/05/20.
//  Copyright (c) 2020 Kevin Oliveira. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so
//  you can apply clean architecture to your iOS and Mac projects,
//  see http://clean-swift.com
//

import Alamofire
import SwiftyJSON
import UIKit

protocol AccountDetailsWorkerLogic {
    func listStatements(userId: Int, _ completion: @escaping ((_ statements: [Statement]?, _ error: Bool?) -> Void))
}

class AccountDetailsWorker: AccountDetailsWorkerLogic {
    func listStatements(userId: Int, _ completion: @escaping ((_ statements: [Statement]?, _ error: Bool?) -> Void)) {
        guard let url = API.getURL(.listStatements, ["userId": userId]) else {
            return completion(nil, true)
        }

        let request = Alamofire.request(url, method: .get, encoding: JSONEncoding.default, headers: API.defaultHeaders)

        request.responseJSON { response in
            switch response.result {
            case .success(let data):
                let json = JSON(data)
                let statementList = json["statementList"]
                let error = json["error"]["message"]

                if (error != JSON.null) {
                    return completion(nil, true)
                }

                var statements: [Statement] = []

                for (_, subJson):(String, JSON) in JSON(statementList) {
                    statements.append(Statement.fromJSON(json: subJson))
                }

                return completion(statements, nil)
            case .failure(_):
                return completion(nil, true)
            }
        }
    }
}
